<!DOCTYPE html> 
<html>

<head>
  <meta charset="utf-8">
  <title> INFO3300 Project 2 </title>
  <h3> Should you move to Canada? </h3>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="http://d3js.org/queue.v1.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=PT+Sans" />
  <link rel='stylesheet' type='text/css' href='css/style.css'>
</head>

<body>

<div id='part1'> 
    <p class='header'> Average Prices in US vs. Canada </p>
    <p>Hover over to see exact item name.</p>
    <figure>
        <figcaption> Click me! </figcaption>
        <img onclick="country(this)" src='images/us.png' id='flag'></img>
    </figure>
    <svg width='1000' height='600' id='usPrices'></svg>
    <svg width='1000' height='600' id='canPrices' style='display: none'></svg>
</div>

<div id='part2'>
    <p class='header'> Winners and losers </p>
    <svg id='winners-losers'></svg>
</div>

<div id='part3'>
    <p class='header'> Why is milk so expensive? </p>

    <p> For the next part of our project, we set out to explore production of milk in the United States and Canada to try to determine why prices are so different. First, we looked at total production of dairy products in both countries over the years to see if there was a relationship between production per capita and prices.</p>
    <svg id='comparing-production-us'></svg>
    <svg id='comparing-production-canada'></svg>

    <p> Next, we looked at operating costs per year to see if higher costs could be resulting in higher prices. </p>
    <svg id='comparing-costs-us'></svg>
    <svg id='comparing-costs-canada'></svg>


    <p>Finally, we looked to see if we could find a correlation between milk prices and producer profits. We calculated profits in both countries per farm, per cow, and per gallon to see if there were any notable differences in each category.</p>
    <svg id='comparing-profits-us'></svg>
    <svg id='comparing-profits-canada'></svg>
</div>

<script> 

   function country() {
        var us = document.getElementById("usPrices");
        var can = document.getElementById("canPrices");
        var flag = document.getElementById("flag");
        if (us.style.display == 'none') {
            us.style.display = 'block';
            can.style.display = 'none';
            flag.src = 'images/us.png';
        } else if (can.style.display == 'none') {
            us.style.display = 'none';
            can.style.display = 'block';
            flag.src = 'images/canada.png';
        };
    };

</script>

<script>

    var dateParse = d3.timeParse("%m/%d/%Y");

    function processing1(row, index, columns) {
        row.Date = dateParse(row.Date);
        return row;
    }

    function callback1(err,data) {
        
        //consulted https://bl.ocks.org/mbostock/3884955
        var items = data.columns.slice(1).map(function(item) {
            return {
                item: item,
                prices: data.map(function(attr) {
                    return {
                        Date: attr.Date,
                        Price: Number(attr[item])
                    };
                })
            };
        });

        //x scale and y scale, z scale for items
        var xScale1 = d3.scaleTime()
                        .domain(d3.extent(data, d => d.Date))
                        .range([80,980]);

        // var yScale1 = d3.scaleLinear()
        //                 .domain([d3.min(items, function(d) { return d3.min(d.prices, function(p) { return p.Price; }); }) ,d3.max(items, function(d) { return d3.max(d.prices, function(p) { return p.Price; }); })])
        //                 .range([550,50]);
        var yScale1 = d3.scaleLinear()
                        .domain([0,9.3])
                        .range([550,50]);
                
        var zScale1 = d3.scaleOrdinal(d3.schemeCategory20b)
                        .domain(items.map(function(items) { return items.items; }));

        var line = d3.line()
            .x(d => xScale1(d.Date))
            .y(d => yScale1(d.Price));

        if (items[0].prices[0].Price == 3.003) {
            
            var USPricesGraph = d3.select("#usPrices");

            //add gridlines
            USPricesGraph.append("g")         
                .attr("class","vLines")
                .attr("transform","translate(0,50)")
                .call(d3.axisBottom(xScale1)
                    .tickSize(500)
                    .tickFormat("")
                );

            var item = USPricesGraph.append('g')
                        .selectAll('.item')
                        .data(items)
                        .enter().append("g")
                        .attr("class","item");

            //add axes
            USPricesGraph.append('g')
                .attr('transform','translate(0,550)')
                .call(d3.axisBottom(xScale1));

            USPricesGraph.append('g')
                .attr('transform','translate(80,0)')
                .call(d3.axisLeft(yScale1));

            //add text
            USPricesGraph.append('text')
                .attr('transform','rotate(270) translate(-340,30)')
                .attr('class','labels')
                .text("Price");

            USPricesGraph.append('text')
                .attr('transform','translate(520,590)')
                .attr('class','labels')
                .text("Date");

            USPricesGraph.append('text')
                .attr('transform', 'translate(80,30)')
                .attr('class','labels')
                .text("Average Prices in US");

        } else {

            var CanPricesGraph = d3.select("#canPrices");

            //add gridlines
            CanPricesGraph.append("g")         
                .attr("class","vLines")
                .attr("transform","translate(0,50)")
                .call(d3.axisBottom(xScale1)
                    .tickSize(500)
                    .tickFormat("")
                );

            var item = CanPricesGraph.append('g')
                        .selectAll('.item')
                        .data(items)
                        .enter().append("g")
                        .attr("class","item");

            //add axes
            CanPricesGraph.append('g')
                .attr('transform','translate(0,550)')
                .call(d3.axisBottom(xScale1));

            CanPricesGraph.append('g')
                .attr('transform','translate(80,0)')
                .call(d3.axisLeft(yScale1));

            //add text
            CanPricesGraph.append('text')
                .attr('transform','rotate(270) translate(-340,30)')
                .attr('class','labels')
                .text("Price");

            CanPricesGraph.append('text')
                .attr('transform','translate(520,590)')
                .attr('class','labels')
                .text("Date");

            CanPricesGraph.append('text')
                .attr('transform', 'translate(80,30)')
                .attr('class','labels')
                .text("Average Prices in Canada");
        }
        //append text labels and paths
        var itemTexts = item.append("text")
            .datum(function(d) { return {item: d.item, price: d.prices[d.prices.length-1]}; })
            .attr("transform", function(d) {return "translate("+xScale1(d.price.Date) + "," + yScale1(d.price.Price) + ")"; })
            .attr("x",-150)
            .attr("y",-55)
            .style("fill",function(d) {return zScale1(d.item); })
            .text(function(d) {return d.item; })
            .attr('id','priceLabels');

        //add mouseover effect, consulted https://stackoverflow.com/questions/40556385/d3-how-can-i-show-hide-a-text-element-when-hovering-a-circle-element-created-f
        var itemLines = item.append("path")
            .attr("class","line")
            .attr("d",function(d) { return line(d.prices); })
            .style("stroke",function(d) { return zScale1(d.item); })
            .style("fill","none")
            .on("mouseover",function(d){
                var textDisplay = itemTexts.filter(function(f) {
                    return f.item == d.item;
                });
                var itemDisplay = itemLines.filter(function(f) {
                    return f.item != d.item;
                });
                textDisplay.style("opacity",1)
                itemDisplay.style("opacity",0.2);
            })
            .on("mouseout",function(d) {
                var textDisplay = itemTexts.filter(function(f) {
                    return f.item == d.item;
                });
                var itemDisplay = itemLines.filter(function(f) {
                    return f.item != d.item;
                });
                textDisplay.style("opacity",0)
                itemLines.style("opacity",1);
            });
    };

    d3.csv("datasets/us.csv",processing1, callback1);
    d3.csv("datasets/canada.csv",processing1,callback1);

</script>

<script>
    var productionWidth = 500;
    var productionHeight = 400;
    var usProductionGraph = d3.select("#comparing-production-us")
                        .attr("width",productionWidth)
                        .attr("height",productionHeight);

    var canadaProductionGraph = d3.select("#comparing-production-canada")
                        .attr("width",productionWidth)
                        .attr("height",productionHeight);

    var usCostGraph = d3.select("#comparing-costs-us")
                        .attr("width",400)
                        .attr("height",400);

    var canadaCostGraph = d3.select("#comparing-costs-canada")
                        .attr("width",400)
                        .attr("height",400);

    var usProfitsGraph = d3.select("#comparing-profits-us")
                        .attr("width",400)
                        .attr("height",400);

    var canadaProfitsGraph = d3.select("#comparing-profits-canada")
                        .attr("width",400)
                        .attr("height",400);

    function usProductionCallback(err, data) {
        var data = data;

        //production graph for US
        var usProductionArray = [];
        for (i=0;i<data.length;i++) {
            //production unit is in tens of thousands of gallons
            usProductionArray[i] = {
                Year: Number(data[i]["Year"]),
                Price: Number(data[i]["Price"]),
                TotalProduction: Number(data[i]["Total Production (in gallons)"])/10000,
                Production: Number(data[i]["Production per Capita"])
            };
        };

        console.log(usProductionArray);

        usProductionxScale = d3.scaleLinear()
                                .domain([2.5,3.9])
                                .range([100,productionWidth-30]);

        // usProductionyScale = d3.scaleLinear()
        //                         .domain([2600000,1980000])
        //                         .range([30,productionHeight-50]);

        usProductionyScale = d3.scaleLinear()
                                .domain([80,69])
                                .range([30,productionHeight-50]);

        var usProductionLine = d3.area()
                    .x(d => usProductionxScale(d.Price))
                    .y(d => usProductionyScale(d.Production));

        usProductionGraph.selectAll("circle")
            .data(usProductionArray)
            .enter().append("circle")
            .attr('r',3)
            .attr('cx',function(d) {return usProductionxScale(d.Price); })
            .attr('cy',function(d) {return usProductionyScale(d.Production); })

        // usProductionGraph.append("path")
        //     .attr("d",usProductionLine(usProductionArray))
        //     .style("stroke","black")
        //     .style('stroke-width',1.5)
        //     .style("fill","none");

         //add axes
        usProductionGraph.append('g')
            .attr('transform','translate(0,350)')
            .call(d3.axisBottom(usProductionxScale));

        usProductionGraph.append('g')
            .attr('transform','translate(100,0)')
            .call(d3.axisLeft(usProductionyScale));

        //add text
        usProductionGraph.append('text')
            .attr('transform','rotate(270) translate(-300,20)')
            .attr('class','labels')
            .text("Production per Capita (gallons)");

        usProductionGraph.append('text')
            .attr('transform','translate(250,390)')
            .attr('class','labels')
            .text("Price (USD)");

        usProductionGraph.append('text')
            .attr('transform', 'translate(220,20)')
            .attr('class','labels')
            .text("Production in US");
    }

    function canadaProductionCallback(err, data) {
        var data = data;

        //production graph for US
        var canadaProductionArray = [];
        for (i=0;i<data.length;i++) {
            //production unit is in tens of thousands of gallons
            canadaProductionArray[i] = {
                Year: Number(data[i]["Year"]),
                Price: Number(data[i]["Price"]),
                TotalProduction: Number(data[i]["Total Production (in gallons)"])/10000,
                Production: Number(data[i]["Production per Capita"])
            };
        };
        console.log(canadaProductionArray);

        canadaProductionxScale = d3.scaleLinear()
                                .domain([3.5,9.5])
                                .range([100,productionWidth-30]);

        canadaProductionyScale = d3.scaleLinear()
                                .domain([66,57])
                                .range([30,productionHeight-50]);

        var canadaProductionLine = d3.area()
                    .x(d => canadaProductionxScale(d.Price))
                    .y(d => canadaProductionyScale(d.Production));

        // canadaProductionGraph.append("path")
        //     .attr("d",canadaProductionLine(canadaProductionArray))
        //     .style("stroke","black")
        //     .style('stroke-width',1.5)
        //     .style("fill","none");

        canadaProductionGraph.selectAll("circle")
            .data(canadaProductionArray)
            .enter().append("circle")
            .attr('r',3)
            .attr('cx',function(d) {return canadaProductionxScale(d.Price); })
            .attr('cy',function(d) {return canadaProductionyScale(d.Production); })


         //add axes
        canadaProductionGraph.append('g')
            .attr('transform','translate(0,350)')
            .call(d3.axisBottom(canadaProductionxScale));

        canadaProductionGraph.append('g')
            .attr('transform','translate(100,0)')
            .call(d3.axisLeft(canadaProductionyScale));

        //add text
        canadaProductionGraph.append('text')
            .attr('transform','rotate(270) translate(-300,20)')
            .attr('class','labels')
            .text("Production per Capita (gallons)");

        canadaProductionGraph.append('text')
            .attr('transform','translate(250,390)')
            .attr('class','labels')
            .text("Price (USD)");

        canadaProductionGraph.append('text')
            .attr('transform', 'translate(220,20)')
            .attr('class','labels')
            .text("Production in Canada");
    }

    d3.csv('datasets/us-farms-income.csv',usProductionCallback);
    d3.csv('datasets/canada-farms-income.csv',canadaProductionCallback);

</script>

</body>

</html>